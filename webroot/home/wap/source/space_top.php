<?php    if(!defined('IN_UCHOME')) { exit('Access Denied'); }  
$multi_mode=true; $perpage = 5; $page = empty($_GET['page'])?1:intval($_GET['page']); if($page<1) $page=1; $start = ($page-1)*$perpage; if(empty($_SCONFIG['networkpage'])) $start = 0;  
ckstart($start, $perpage);  
$cache_file = ''; $cache_time = $_SCONFIG['topcachetime']; if($cache_time<5) $cache_time = 5; $fuids = array(); $count = 0; $now_pos = 0; if(!in_array($_GET['view'], array('online','mm','gg','credit','experience','friendnum','viewnum','updatetime'))) $_GET['view'] = 'show'; if ($_GET['view'] == 'show') { $c_sql = "\123\x45\114ECT COUNT(*) \106\x52OM ".tname('show'); $sql = "\123\105L\105\x43T space.*, \146\151\x65ld.*, \155\141in.* \106ROM ".tname('show')." \155a\x69\156
		LEFT JOIN ".tname('space')." space \x4fN space.uid=\155\141\x69n.uid
		LEFT JOIN ".tname('spacefield')." f\x69e\154\144 O\x4e fi\x65\x6c\144.uid=\155a\x69n.uid
		ORDER BY \155\x61\x69n.credit DESC";  
if(substr($_SGLOBAL['timestamp'], -1) == '0') { $_SGLOBAL['db']->query("DELETE \106R\117\x4d ".tname('show')." WHERE credit<1"); 
}  
$space['showcredit'] = getcount('show', array('uid'=>$space['uid']), 'credit'); $space['showcredit'] = intval($space['showcredit']);  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query("\x53\105L\105\x43\124 COUNT(*) \x46\x52OM ".tname('show')." WHERE credit>'$space[showcredit]'"), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'mm') { if($multi_mode) { $c_sql = "\x53E\114\x45\x43T COUNT(*) \x46R\x4fM ".tname('spacefield')." WHERE sex='2'"; } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_mm.txt'; } $sql = "\x53\105\x4cECT \x6da\x69n.*, f\x69e\154\x64.* \106\x52O\x4d ".tname('space')." \x6d\x61\x69\156, ".tname('spacefield')." \x66i\145ld
		WHERE fiel\144.sex='2' AND f\x69el\144.uid=\155\141\x69\x6e.uid
		ORDER BY \155ain.viewnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { if($space['sex']==2) { $pos_sql = "\123\x45L\x45\x43\124 COUNT(*) F\x52O\x4d ".tname('space')." s, ".tname('spacefield')." f WHERE s.viewnum>'$space[viewnum]' AND f.sex='2' AND f.uid=s.uid"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; } else { $now_pos = -1; } ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'gg') { if($multi_mode) { $c_sql = "\123\x45\114\x45\103T COUNT(*) F\x52O\115 ".tname('spacefield')." WHERE sex='1'"; } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_gg.txt'; } $sql = "\x53EL\x45\x43\x54 \x6d\x61\x69\156.*, \146i\x65\x6c\144.* \106\x52\117M ".tname('space')." \155\x61i\x6e, ".tname('spacefield')." f\151\x65\x6c\x64
		WHERE \146\x69e\x6c\x64.sex='1' AND \146i\145\x6c\144.uid=\155\x61\151\156.uid
		ORDER BY \x6d\141i\156.viewnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { if($space['sex']==1) { $pos_sql = "\123E\x4cECT COUNT(*) F\x52O\x4d ".tname('space')." s, ".tname('spacefield')." f WHERE s.viewnum>'$space[viewnum]' AND f.sex='1' AND f.uid=s.uid"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; } else { $now_pos = -1; } ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'credit') { if($multi_mode) { $c_sql = "SEL\105C\x54 COUNT(*) F\122\x4fM ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_credit.txt'; } $sql = "SE\114\105\x43\124 ma\151n.*, \x66i\x65ld.* \x46\122O\115 ".tname('space')." \x6da\151\x6e
		LEFT JOIN ".tname('spacefield')." \146\151\145\x6c\x64 ON \146\151e\x6c\x64.uid=m\x61i\156.uid
		ORDER BY m\x61\x69\x6e.credit DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "S\x45\x4cE\103T COUNT(*) \106\x52\x4f\115 ".tname('space')." s WHERE s.credit>'$space[credit]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'experience') { if($multi_mode) { $c_sql = "S\105\x4c\x45\x43T COUNT(*) \x46\122\117\x4d ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_experience.txt'; } $sql = "\123\105LECT \x6d\x61i\x6e.*, f\x69\145\x6c\144.* \106\x52\x4f\x4d ".tname('space')." \x6da\x69n
		LEFT JOIN ".tname('spacefield')." \x66i\x65\154\x64 \117N fi\145\154\144.uid=\x6d\141\151n.uid
		ORDER BY m\x61in.experience DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "\x53\105\x4cE\103T COUNT(*) \x46\122O\115 ".tname('space')." s WHERE s.experience>'$space[experience]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'friendnum') { if($multi_mode) { $c_sql = "\x53\x45\114\x45C\124 COUNT(*) \106ROM ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_friendnum.txt'; } $sql = "S\105L\x45\103T \155\141\151n.*, \x66i\145\x6c\x64.* \106\x52\x4f\115 ".tname('space')." main
		LEFT JOIN ".tname('spacefield')." fi\x65l\x64 O\x4e \146\151\145\x6c\x64.uid=ma\151\156.uid
		ORDER BY main.friendnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "\123\x45LE\x43\124 COUNT(*) F\122\117M ".tname('space')." s WHERE s.friendnum>'$space[friendnum]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'viewnum') { if($multi_mode) { $c_sql = "S\x45\x4cE\103\124 COUNT(*) \x46R\x4fM ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_viewnum.txt'; } $sql = "\123\x45L\x45C\x54 \155\141in.*, \x66i\x65l\144.* \106RO\x4d ".tname('space')." ma\x69\x6e
		LEFT JOIN ".tname('spacefield')." \146\x69\x65\154\144 \x4f\x4e \146i\145l\144.uid=\155\141\x69\156.uid
		ORDER BY \x6d\x61\x69n.viewnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "\123\105\x4c\x45\103\124 COUNT(*) \x46RO\x4d ".tname('space')." s WHERE s.viewnum>'$space[viewnum]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'online') { $c_sql = "\123\105\114\x45C\x54 COUNT(*) \106\x52\117M ".tname('session'); $sql = "S\x45L\x45C\124 \x66\x69e\154\x64.*, space.*, m\x61\151n.*
		F\x52\x4f\x4d ".tname('session')." \x6d\141\151\x6e USE IN\x44\105\130 (\x6cas\164\x61\x63\164\151v\151t\x79)
		LEFT JOIN ".tname('space')." space \117\116 space.uid=m\x61i\x6e.uid
		LEFT JOIN ".tname('spacefield')." \146i\x65\154d O\116 \x66\151\145l\x64.uid=m\141\x69n.uid
		ORDER BY m\141i\156.l\x61\x73t\141\143\164\x69\166i\x74\x79 DESC"; $now_pos = -1; } elseif ($_GET['view'] == 'updatetime') { $c_sql = "\123E\114\x45CT COUNT(*) \x46\x52\117\115 ".tname('space'); $sql = "\123E\x4c\105\x43T m\141\151\156.*, f\x69\145\x6c\x64.* FR\117\115 ".tname('space')." \155\141i\x6e USE \x49NDE\130 (updatetime)
		LEFT JOIN ".tname('spacefield')." \x66\x69\145l\x64 \x4fN \146\151\145\x6cd.uid=\x6d\141\x69\x6e.uid
		ORDER BY \155\141i\156.updatetime DESC"; $now_pos = -1; } $list = array(); if(empty($count)) { $cache_mode = false; $count = empty($_SCONFIG['networkpage'])?1:$_SGLOBAL['db']->result($_SGLOBAL['db']->query($c_sql),0); $multi = multi($count, $perpage, $page, "space.ph\160?\144\157=t\x6f\160&view=$_GET[view]"); } else { $cache_mode = true; $multi = ''; $start = 0; $perpage = $count; if($cache_file && file_exists($cache_file) && $_SGLOBAL['timestamp'] - @filemtime($cache_file) < $cache_time*60) { $list_cache = sreadfile($cache_file); $list = unserialize($list_cache); } } if($count && empty($list)) { $query = $_SGLOBAL['db']->query("$sql LIMIT $start,$perpage"); while ($value = $_SGLOBAL['db']->fetch_array($query)) { $list[$value['uid']] = $value; } if($cache_mode && $cache_file) { swritefile($cache_file, serialize($list)); } } foreach($list as $key => $value) { $value['isfriend'] = ($value['uid']==$space['uid'] || ($space['friends'] && in_array($value['uid'], $space['friends'])))?1:0; realname_set($value['uid'], $value['username'], $value['name'], $value['namestatus']); $fuids[] = $value['uid']; $list[$key] = $value; }  
$ols = array(); if($fuids) { $query = $_SGLOBAL['db']->query("\x53\105\x4c\x45\x43\x54 * F\122\x4fM ".tname('session')." WHERE uid IN (".simplode($fuids).")"); while ($value = $_SGLOBAL['db']->fetch_array($query)) { if(!$value['magichidden']) { $ols[$value['uid']] = $value['lastactivity']; } elseif ($_GET['view'] == 'online' && $list[$value['uid']]) { unset($list[$value['uid']]); } } } $actives = array($_GET['view'] => ' class="active"'); include_once template("space_top");  ?>
